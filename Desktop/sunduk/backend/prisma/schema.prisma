// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Language {
  id        String   @id @default(cuid())
  code      String   @unique // 'tr', 'ru'
  name      String
  flag_icon String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  nativeUsers      User[]              @relation("NativeLanguage")
  learningUsers    User[]              @relation("LearningLanguage")
  unitTranslations UnitTranslation[]
  lessonTranslations LessonTranslation[]
  exercisePrompts  ExercisePrompt[]
  optionTranslations ExerciseOptionTranslation[]
  examTranslations ExamTranslation[]
  examQuestionPrompts ExamQuestionPrompt[]
  examQuestionOptionTranslations ExamQuestionOptionTranslation[]
  dialogTranslations DialogTranslation[]
  dialogCharacterTranslations DialogCharacterTranslation[]
  dialogMessageTranslations DialogMessageTranslation[]
  dialogQuestionPrompts DialogQuestionPrompt[]
  dialogQuestionOptionTranslations DialogQuestionOptionTranslation[]

  @@map("languages")
}

model User {
  id                 String   @id @default(cuid())
  email              String   @unique
  passwordHash       String   @map("password_hash")
  username           String
  role               String   @default("user") // 'user' or 'admin'
  nativeLanguageId   String   @map("native_language_id")
  learningLanguageId String   @map("learning_language_id")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  nativeLanguage   Language         @relation("NativeLanguage", fields: [nativeLanguageId], references: [id])
  learningLanguage Language         @relation("LearningLanguage", fields: [learningLanguageId], references: [id])
  progress         UserProgress[]
  subscriptions    UserSubscription[]
  lessonCompletions UserLessonCompletion[]
  examCompletions  UserExamCompletion[]

  @@map("users")
}

model Level {
  id        String   @id @default(cuid())
  code      String   @unique // 'A1', 'A2', etc.
  order     Int
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  units Unit[]
  dialogs Dialog[]

  @@map("levels")
}

model Unit {
  id        String   @id @default(cuid())
  levelId   String   @map("level_id")
  order     Int
  slug      String
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  level         Level              @relation(fields: [levelId], references: [id])
  lessons       Lesson[]
  translations  UnitTranslation[]
  exams         Exam[]
  dialogs       Dialog[]

  @@unique([levelId, slug])
  @@map("units")
}

model UnitTranslation {
  id          String   @id @default(cuid())
  unitId      String   @map("unit_id")
  languageId  String   @map("language_id")
  title       String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  unit     Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)
  language Language @relation(fields: [languageId], references: [id])

  @@unique([unitId, languageId])
  @@map("unit_translations")
}

model Lesson {
  id           String   @id @default(cuid())
  unitId       String   @map("unit_id")
  order        Int
  isFree       Boolean  @default(false) @map("is_free")
  passingScore Float    @default(70) @map("passing_score") // Geçme yüzdesi (0-100)
  iconType     String?  @default("star") @map("icon_type") // Ders ikonu tipi
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  unit         Unit                @relation(fields: [unitId], references: [id])
  translations LessonTranslation[]
  exercises    Exercise[]
  exams        Exam[]              // Sınavlar bu dersin sonrasına yerleşir
  dialogs      Dialog[]            // Dialog'lar bu derse bağlı olabilir
  progress     UserProgress[]
  completions  UserLessonCompletion[]

  @@map("lessons")
}

model LessonTranslation {
  id         String   @id @default(cuid())
  lessonId   String   @map("lesson_id")
  languageId String   @map("language_id")
  title      String
  contentMd  String   @map("content_md") // Markdown content
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  lesson   Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  language Language @relation(fields: [languageId], references: [id])

  @@unique([lessonId, languageId])
  @@map("lesson_translations")
}

model Exercise {
  id            String   @id @default(cuid())
  lessonId      String   @map("lesson_id")
  type          String   // 'multiple_choice', 'listening', etc.
  correctAnswer String?  @map("correct_answer")
  mediaUrl      String?  @map("media_url")
  order         Int      @default(0)
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  lesson   Lesson              @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  prompts  ExercisePrompt[]
  options  ExerciseOption[]

  @@map("exercises")
}

model ExercisePrompt {
  id          String   @id @default(cuid())
  exerciseId  String   @map("exercise_id")
  languageId  String   @map("language_id")
  questionText String  @map("question_text")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  exercise Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  language Language @relation(fields: [languageId], references: [id])

  @@unique([exerciseId, languageId])
  @@map("exercise_prompts")
}

model ExerciseOption {
  id         String   @id @default(cuid())
  exerciseId String   @map("exercise_id")
  order      Int      @default(0)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  exercise    Exercise                  @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  translations ExerciseOptionTranslation[]

  @@map("exercise_options")
}

model ExerciseOptionTranslation {
  id         String   @id @default(cuid())
  optionId   String   @map("option_id")
  languageId String   @map("language_id")
  optionText String   @map("option_text")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  option   ExerciseOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  language Language        @relation(fields: [languageId], references: [id])

  @@unique([optionId, languageId])
  @@map("exercise_option_translations")
}

model UserProgress {
  id            String    @id @default(cuid())
  userId        String    @map("user_id")
  currentLessonId String? @map("current_lesson_id")
  completedAt   DateTime? @map("completed_at")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  // Relations
  user        User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  currentLesson Lesson? @relation(fields: [currentLessonId], references: [id])

  @@unique([userId])
  @@map("user_progress")
}

model UserLessonCompletion {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  lessonId    String   @map("lesson_id")
  score       Float    // Percentage score (0-100)
  correctCount Int     @map("correct_count")
  totalCount  Int      @map("total_count")
  completed   Boolean  @default(false)
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  lesson Lesson @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@unique([userId, lessonId])
  @@map("user_lesson_completions")
}

model UserExamCompletion {
  id          String   @id @default(cuid())
  userId      String   @map("user_id")
  examId     String   @map("exam_id")
  score       Float    // Percentage score (0-100)
  correctCount Int     @map("correct_count")
  totalCount  Int      @map("total_count")
  completed   Boolean  @default(false)
  completedAt DateTime? @map("completed_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  exam Exam @relation(fields: [examId], references: [id], onDelete: Cascade)

  @@unique([userId, examId])
  @@map("user_exam_completions")
}

model UserSubscription {
  id        String    @id @default(cuid())
  userId    String    @map("user_id")
  startDate DateTime  @map("start_date")
  endDate   DateTime  @map("end_date")
  status    String    @default("active") // 'active' or 'expired'
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_subscriptions")
}

model Exam {
  id           String   @id @default(cuid())
  unitId       String   @map("unit_id")
  lessonId     String?  @map("lesson_id") // Optional: Eğer belirtilirse sınav o dersin sonrasına yerleşir
  order        Int
  passingScore Float    @default(70) @map("passing_score") // Geçme yüzdesi (0-100)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  unit         Unit              @relation(fields: [unitId], references: [id], onDelete: Cascade)
  lesson       Lesson?           @relation(fields: [lessonId], references: [id], onDelete: SetNull)
  translations ExamTranslation[]
  questions    ExamQuestion[]
  completions  UserExamCompletion[]

  @@map("exams")
}

model ExamTranslation {
  id          String   @id @default(cuid())
  examId      String   @map("exam_id")
  languageId  String   @map("language_id")
  title       String
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  exam     Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  language Language @relation(fields: [languageId], references: [id])

  @@unique([examId, languageId])
  @@map("exam_translations")
}

model ExamQuestion {
  id            String   @id @default(cuid())
  examId        String   @map("exam_id")
  order         Int      @default(0)
  type          String   // 'multiple_choice', 'listening', etc.
  correctAnswer String?  @map("correct_answer")
  mediaUrl      String?  @map("media_url")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  exam     Exam                  @relation(fields: [examId], references: [id], onDelete: Cascade)
  prompts  ExamQuestionPrompt[]
  options  ExamQuestionOption[]

  @@map("exam_questions")
}

model ExamQuestionPrompt {
  id          String   @id @default(cuid())
  questionId  String   @map("question_id")
  languageId  String   @map("language_id")
  questionText String  @map("question_text")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  question ExamQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  language Language      @relation(fields: [languageId], references: [id])

  @@unique([questionId, languageId])
  @@map("exam_question_prompts")
}

model ExamQuestionOption {
  id         String   @id @default(cuid())
  questionId String   @map("question_id")
  order      Int      @default(0)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  question    ExamQuestion                  @relation(fields: [questionId], references: [id], onDelete: Cascade)
  translations ExamQuestionOptionTranslation[]

  @@map("exam_question_options")
}

model ExamQuestionOptionTranslation {
  id         String   @id @default(cuid())
  optionId   String   @map("option_id")
  languageId String   @map("language_id")
  optionText String   @map("option_text")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  option   ExamQuestionOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  language Language           @relation(fields: [languageId], references: [id])

  @@unique([optionId, languageId])
  @@map("exam_question_option_translations")
}

// Dialog Models
model Dialog {
  id          String   @id @default(cuid())
  unitId      String?  @map("unit_id")
  lessonId    String?  @map("lesson_id")
  levelId     String?  @map("level_id")
  order       Int
  isFree      Boolean  @default(false) @map("is_free")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  unit         Unit?              @relation(fields: [unitId], references: [id], onDelete: SetNull)
  lesson       Lesson?            @relation(fields: [lessonId], references: [id], onDelete: SetNull)
  level        Level?             @relation(fields: [levelId], references: [id], onDelete: SetNull)
  translations DialogTranslation[]
  characters   DialogCharacter[]
  messages     DialogMessage[]
  questions    DialogQuestion[]

  @@map("dialogs")
}

model DialogTranslation {
  id          String   @id @default(cuid())
  dialogId    String   @map("dialog_id")
  languageId  String   @map("language_id")
  title       String
  description String?
  scenario    String?  // Senaryo açıklaması
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  dialog   Dialog   @relation(fields: [dialogId], references: [id], onDelete: Cascade)
  language Language @relation(fields: [languageId], references: [id])

  @@unique([dialogId, languageId])
  @@map("dialog_translations")
}

model DialogCharacter {
  id        String   @id @default(cuid())
  dialogId  String   @map("dialog_id")
  order     Int      @default(0)
  avatarUrl String?  @map("avatar_url")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  dialog       Dialog                    @relation(fields: [dialogId], references: [id], onDelete: Cascade)
  translations DialogCharacterTranslation[]
  messages     DialogMessage[]

  @@map("dialog_characters")
}

model DialogCharacterTranslation {
  id         String   @id @default(cuid())
  characterId String   @map("character_id")
  languageId String   @map("language_id")
  name       String
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  character DialogCharacter @relation(fields: [characterId], references: [id], onDelete: Cascade)
  language  Language        @relation(fields: [languageId], references: [id])

  @@unique([characterId, languageId])
  @@map("dialog_character_translations")
}

model DialogMessage {
  id         String   @id @default(cuid())
  dialogId   String   @map("dialog_id")
  characterId String   @map("character_id")
  order      Int      @default(0)
  audioUrl   String?  @map("audio_url")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  dialog      Dialog                @relation(fields: [dialogId], references: [id], onDelete: Cascade)
  character   DialogCharacter       @relation(fields: [characterId], references: [id], onDelete: Cascade)
  translations DialogMessageTranslation[]

  @@map("dialog_messages")
}

model DialogMessageTranslation {
  id         String   @id @default(cuid())
  messageId  String   @map("message_id")
  languageId String   @map("language_id")
  text       String
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  message  DialogMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  language Language      @relation(fields: [languageId], references: [id])

  @@unique([messageId, languageId])
  @@map("dialog_message_translations")
}

model DialogQuestion {
  id            String   @id @default(cuid())
  dialogId      String   @map("dialog_id")
  order         Int      @default(0)
  type          String   // 'multiple_choice', 'fill_blank', 'matching', etc.
  correctAnswer String?  @map("correct_answer")
  mediaUrl      String?  @map("media_url")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  dialog    Dialog                @relation(fields: [dialogId], references: [id], onDelete: Cascade)
  prompts   DialogQuestionPrompt[]
  options   DialogQuestionOption[]

  @@map("dialog_questions")
}

model DialogQuestionPrompt {
  id          String   @id @default(cuid())
  questionId  String   @map("question_id")
  languageId  String   @map("language_id")
  questionText String  @map("question_text")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  question DialogQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  language Language        @relation(fields: [languageId], references: [id])

  @@unique([questionId, languageId])
  @@map("dialog_question_prompts")
}

model DialogQuestionOption {
  id         String   @id @default(cuid())
  questionId String   @map("question_id")
  order      Int      @default(0)
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  question    DialogQuestion                @relation(fields: [questionId], references: [id], onDelete: Cascade)
  translations DialogQuestionOptionTranslation[]

  @@map("dialog_question_options")
}

model DialogQuestionOptionTranslation {
  id         String   @id @default(cuid())
  optionId   String   @map("option_id")
  languageId String   @map("language_id")
  optionText String   @map("option_text")
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  // Relations
  option   DialogQuestionOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  language Language             @relation(fields: [languageId], references: [id])

  @@unique([optionId, languageId])
  @@map("dialog_question_option_translations")
}

